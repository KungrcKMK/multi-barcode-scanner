<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Native Fast Scanner</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
        #video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        #ui-layer { position: absolute; bottom: 20px; left: 10px; right: 10px; z-index: 3; pointer-events: none; }
        #status-box { background: rgba(0, 0, 0, 0.8); color: white; padding: 15px; border-radius: 12px; max-height: 250px; overflow-y: auto; pointer-events: auto; }
        
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #start-btn { padding: 15px 30px; font-size: 1.2rem; background: #28a745; color: white; border: none; border-radius: 50px; cursor: pointer; }
        
        .code-item { border-bottom: 1px solid #444; padding: 8px 0; display: flex; justify-content: space-between; font-family: monospace; font-size: 0.9rem; }
        .format-badge { background: #007bff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: white; margin-right: 8px; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h2>Native Barcode API</h2>
        <button id="start-btn" onclick="startCamera()">เริ่มสแกน (รวดเร็วพิเศษ)</button>
    </div>

    <video id="video" playsinline muted autoplay></video>
    <canvas id="overlay"></canvas>

    <div id="ui-layer">
        <div id="status-box">
            <div style="font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #555; padding-bottom: 5px;">
                สแกนพบ: <span id="count">0</span>
            </div>
            <div id="codes-list"></div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('overlay');
        const ctx = canvas.getContext('2d');
        const foundCodes = new Set();
        let barcodeDetector;

        // ตรวจสอบว่า Browser รองรับเทคโนโลยีนี้หรือไม่
        if (!('BarcodeDetector' in window)) {
            alert("อุปกรณ์/Browser ของคุณไม่รองรับ Native Barcode API แนะนำให้ใช้ Google Chrome บน Android หรือ macOS ครับ");
        } else {
            // ตั้งค่าให้อ่านเฉพาะ Barcode ทั่วไป (ตัด QR ออกไปก่อนเพื่อให้โฟกัสบาร์โค้ด)
            barcodeDetector = new BarcodeDetector({ 
                formats: ['ean_13', 'code_128', 'code_39', 'ean_8', 'itf', 'qr_code'] 
            });
        }

        async function startCamera() {
            document.getElementById('start-screen').style.display = 'none';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = stream;
                
                // รอให้วิดีโอเล่นก่อนค่อยเริ่มสแกน
                video.addEventListener('play', () => {
                    requestAnimationFrame(scanLoop);
                });
            } catch (err) {
                alert("เปิดกล้องไม่ได้: " + err.message);
            }
        }

        async function scanLoop() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                try {
                    // คำสั่งค้นหาบาร์โค้ดทั้งหมดในเฟรม (เร็วมากและอ่านเอียงได้)
                    const barcodes = await barcodeDetector.detect(video);
                    
                    if (barcodes.length > 0) {
                        barcodes.forEach(barcode => {
                            drawBoundingBox(barcode);
                            
                            const codeValue = barcode.rawValue;
                            if (!foundCodes.has(codeValue)) {
                                foundCodes.add(codeValue);
                                beep();
                                addToList(codeValue, barcode.format);
                            }
                        });
                    }
                } catch (e) {
                    // ข้าม error ไปเพื่อไม่ให้ loop ค้าง
                }
            }
            // วนลูปสแกนเฟรมถัดไป
            requestAnimationFrame(scanLoop);
        }

        function drawBoundingBox(barcode) {
            const { cornerPoints } = barcode;
            if (!cornerPoints || cornerPoints.length === 0) return;

            ctx.strokeStyle = '#00FF00';
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(cornerPoints[0].x, cornerPoints[0].y);
            for (let i = 1; i < cornerPoints.length; i++) {
                ctx.lineTo(cornerPoints[i].x, cornerPoints[i].y);
            }
            ctx.closePath();
            ctx.stroke();
        }

        function addToList(text, format) {
            const list = document.getElementById('codes-list');
            const div = document.createElement('div');
            div.className = 'code-item';
            div.innerHTML = `<span><span class="format-badge">${format.toUpperCase()}</span>${text}</span>`;
            list.prepend(div);
            document.getElementById('count').innerText = foundCodes.size;
        }

        function beep() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                osc.type = 'square';
                osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                osc.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.05);
            } catch(e) {}
        }
    </script>
</body>
</html>
