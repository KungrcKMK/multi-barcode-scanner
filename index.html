<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Barcode Scanner (Random Direction)</title>
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            background: #f4f7f9; margin: 0; padding: 20px;
        }
        h2 { color: #2c3e50; margin-bottom: 10px; }
        
        #scanner-wrapper {
            position: relative;
            width: 100%;
            max-width: 640px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        video { width: 100%; height: auto; display: block; }
        
        /* Canvas สำหรับวาดเส้น Highlight ทับบาร์โค้ด */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #result-panel {
            width: 100%;
            max-width: 640px;
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        #codes-list {
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .code-entry {
            background: #e8f0fe;
            padding: 10px;
            border-left: 4px solid #1a73e8;
            border-radius: 4px;
            font-family: monospace;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
        }
        
        .timestamp { color: #666; font-size: 0.8em; }
        
        .btn-clear {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h2>Multi-Scanner (HTTPS)</h2>
    
    <div id="scanner-wrapper">
        <video id="video"></video>
        <canvas id="overlay"></canvas>
    </div>

    <div id="result-panel">
        <div class="status-bar">
            <strong>พบแล้ว: <span id="count">0</span> รายการ</strong>
            <button class="btn-clear" onclick="clearResults()">ล้างข้อมูล</button>
        </div>
        <div id="codes-list">
            </div>
    </div>

    <script>
        const codeReader = new ZXing.BrowserMultiFormatReader();
        const videoElement = document.getElementById('video');
        const overlayCanvas = document.getElementById('overlay');
        const overlayCtx = overlayCanvas.getContext('2d');
        const listContainer = document.getElementById('codes-list');
        const countDisplay = document.getElementById('count');

        let scannedCodes = new Set();

        // ฟังก์ชันสร้างเสียง Beep
        function playBeep() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        async function initScanner() {
            try {
                const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
                const firstDeviceId = devices[0].deviceId;

                // ตั้งค่าการสแกนแบบสุ่มทิศทาง (TRY_HARDER)
                const hints = new Map();
                hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                // ระบุ Format ที่ต้องการ (สแกนได้ทั้ง Barcode และ QR)
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                    ZXing.BarcodeFormat.CODE_128,
                    ZXing.BarcodeFormat.EAN_13,
                    ZXing.BarcodeFormat.QR_CODE,
                    ZXing.BarcodeFormat.CODE_39
                ]);

                codeReader.decodeFromVideoDevice(firstDeviceId, 'video', (result, err) => {
                    // ปรับขนาด Canvas ให้ตรงกับวิดีโอเสมอ
                    overlayCanvas.width = videoElement.videoWidth;
                    overlayCanvas.height = videoElement.videoHeight;

                    if (result) {
                        const rawText = result.getText();
                        
                        // ถ้าเจอโค้ดใหม่
                        if (!scannedCodes.has(rawText)) {
                            scannedCodes.add(rawText);
                            playBeep();
                            addToList(rawText);
                            drawBox(result.getResultPoints());
                        }
                    }
                }, hints);

            } catch (err) {
                console.error(err);
                alert("กรุณาตรวจสอบว่าคุณใช้ HTTPS หรือ Localhost และอนุญาตให้เข้าถึงกล้องแล้ว");
            }
        }

        function addToList(text) {
            const now = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = 'code-entry';
            div.innerHTML = `<span>${text}</span> <span class="timestamp">${now}</span>`;
            listContainer.prepend(div);
            countDisplay.innerText = scannedCodes.size;
        }

        function drawBox(points) {
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            if (points) {
                overlayCtx.strokeStyle = '#00ff00';
                overlayCtx.lineWidth = 5;
                overlayCtx.beginPath();
                overlayCtx.moveTo(points[0].x, points[0].y);
                points.forEach(p => overlayCtx.lineTo(p.x, p.y));
                overlayCtx.closePath();
                overlayCtx.stroke();
                
                // ลบกรอบออกหลังจาก 1 วินาที
                setTimeout(() => {
                    overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                }, 1000);
            }
        }

        function clearResults() {
            scannedCodes.clear();
            listContainer.innerHTML = '';
            countDisplay.innerText = '0';
        }

        // เริ่มต้นระบบ
        initScanner();
    </script>
</body>
</html>